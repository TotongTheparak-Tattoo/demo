FROM python:3.11-slim

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Bangkok

WORKDIR /app

# ---- System deps & Microsoft SQL ODBC repo (Debian 12 / bookworm) ----
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
      ca-certificates curl gnupg2 tzdata \
      cron build-essential \
      gcc g++ \
      unixodbc unixodbc-dev \
 && install -d -m 0755 /etc/apt/keyrings \
 # add Microsoft signing key (keyring)
 && curl -fsSL https://packages.microsoft.com/keys/microsoft.asc \
      | gpg --dearmor -o /etc/apt/keyrings/microsoft.gpg \
 # add Microsoft repo for Debian 12 (bookworm)
 && echo "deb [signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/debian/12/prod bookworm main" \
      > /etc/apt/sources.list.d/mssql-release.list \
 && apt-get update \
 # accept EULA and install ODBC 18 + tools 18
 && ACCEPT_EULA=Y apt-get install -y --no-install-recommends msodbcsql18 mssql-tools18 \
 # make sqlcmd/bcp available in PATH
 && ln -s /opt/mssql-tools18/bin/sqlcmd /usr/local/bin/sqlcmd \
 && ln -s /opt/mssql-tools18/bin/bcp /usr/local/bin/bcp \
 # cleanup
 && rm -rf /var/lib/apt/lists/*

# ---- Python deps ----
COPY ./requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir --upgrade -r /app/requirements.txt

# ---- App code ----
COPY . .

# ถ้ามี entrypoint ให้เปิดสองบรรทัดด้านล่าง
# RUN chmod +x /app/entrypoint.sh
# ENTRYPOINT ["/app/entrypoint.sh"]

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
